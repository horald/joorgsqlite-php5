<?php
header("content-type: text/html; charset=utf-8");

function statusvorauswahl($menu,$filterarray) {
  echo "<form class='form-horizontal' method='post' action='status.php?status=1&menu=".$menu."'>";

  $count=sizeof($filterarray);
  echo "<select name='auswahltyp' size='1'>";
  for ( $x = 0; $x < $count; $x++ ) {
    echo "<option style='background-color:#c0c0c0;' value='".$filterarray[$x]['dbfield']."'>".$filterarray[$x]['label']."</option>";
  }
//  echo "<option style='background-color:#c0c0c0;' >Status</option>";
//  echo "<option style='background-color:#c0c0c0;' >Rechdatum</option>";
//  echo "<option style='background-color:#c0c0c0;' >Einkaufsort</option>";
  echo "<option style='background-color:#c0c0c0;' value='SYNC'>SYNC</option>";
  echo "<option style='background-color:#c0c0c0;' value='NOSYNC'>NOSYNC</option>";
  echo "</select>";

  echo "<dd><input type='submit' value='Weiter' /></dd>";
  echo "</form>";
}

function statusauswahl($menu,$auswahltyp,$dbtable) {
//echo $auswahltyp."=auswahltyp<br>";	
  $db = new SQLite3('../data/joorgsqlite.db');
  echo "<form class='form-horizontal' method='post' action='status.php?status=2&menu=".$menu."'>";
  echo "<input type='hidden' name='auswahltyp' value='".$auswahltyp."' />";

  echo "<table>";

  if ($auswahltyp<>"Einkaufsort") {
  $default = date('Y-m-d');
  echo "<tr>";
  echo "<td><label >Von Datum:</label></td>";
  echo "<td><div class='input-group date form_date col-md-12' data-date='' data-date-format='yyyy-mm-dd' data-link-field='dtp_input2' data-link-format='yyyy-mm-dd'>";
  echo "<input class='form-control' size='8' type='text' name='vondatum' value='".$default."' >";
  echo "<span class='input-group-addon'><span class='glyphicon glyphicon-calendar'></span></span>";
  echo "</div></td>";
  echo "<input type='hidden' id='dtp_input2' value='' />";
  echo "</tr>";

  $default = date('Y-m-d');
  echo "<tr>";
  echo "<td><label >Bis Datum:</label></td>";
  echo "<td><div class='input-group date form_date col-md-12' data-date='' data-date-format='yyyy-mm-dd' data-link-field='dtp_input2' data-link-format='yyyy-mm-dd'>";
  echo "<input class='form-control' size='8' type='text' name='bisdatum' value='".$default."' >";
  echo "<span class='input-group-addon'><span class='glyphicon glyphicon-calendar'></span></span>";
  echo "</div></td>";
  echo "<input type='hidden' id='dtp_input2' value='' />";
  echo "</tr>";
  }

  if ($auswahltyp=="Status") {
    $sql="SELECT * FROM tblstatus";
    $results = $db->query($sql);
    echo "<tr>";
    echo "<td><label >Von Status:</label></td>";
    echo "<td><select name='vonstatus' size='1'>";
    echo "<option style='background-color:#c0c0c0;' >(ohne)</option>";
    while ($row = $results->fetchArray()) {
      echo "<option style='background-color:#c0c0c0;' >".$row['fldbez']."</option>";
    }
    echo "</select></td>";
    echo "</tr>";

    $sql="SELECT * FROM tblstatus";
    $results = $db->query($sql);
    echo "<tr>";
    echo "<td><label >Nach Status:</label></td>";
    echo "<td><select name='nchstatus' size='1'>";
    echo "<option style='background-color:#c0c0c0;' >(ohne)</option>";
    while ($row = $results->fetchArray()) {
//    echo "<option style='background-color:#c0c0c0;'  value=".$row['fldindex'].">".$row['fldbez']."</option>";
      echo "<option style='background-color:#c0c0c0;' >".$row['fldbez']."</option>";
    }
    echo "</select></td>";
    echo "</tr>";
  }  
  if ($auswahltyp=="Einkaufsort") {
    $sql="SELECT * FROM tblorte WHERE fldo01typ='FREMD'";
    $results = $db->query($sql);
    echo "<tr>";
    echo "<td><label >Von Ort:</label></td>";
    echo "<td><select name='vonort' size='1'>";
    echo "<option style='background-color:#c0c0c0;' >(ohne)</option>";
    while ($row = $results->fetchArray()) {
      echo "<option style='background-color:#c0c0c0;' >".$row['fldBez']."</option>";
    }
    echo "</select></td>";
    echo "</tr>";

    $sql="SELECT * FROM tblorte WHERE fldo01typ='FREMD'";
    $results = $db->query($sql);
    echo "<tr>";
    echo "<td><label >Nach Ort:</label></td>";
    echo "<td><select name='nchort' size='1'>";
    echo "<option style='background-color:#c0c0c0;' >(ohne)</option>";
    while ($row = $results->fetchArray()) {
//    echo "<option style='background-color:#c0c0c0;'  value=".$row['fldindex'].">".$row['fldbez']."</option>";
      echo "<option style='background-color:#c0c0c0;' >".$row['fldBez']."</option>";
    }
    echo "</select></td>";
    echo "</tr>";
  }  
  if ($auswahltyp=="Rechdatum") {
    $sql="SELECT * FROM tblrechdat";
    $results = $db->query($sql);
    echo "<tr>";
    echo "<td><label >Rechdatum:</label></td>";
    echo "<td><select name='rechdat' size='1'>";
    echo "<option style='background-color:#c0c0c0;' >(ohne)</option>";
    while ($row = $results->fetchArray()) {
    echo "<option style='background-color:#c0c0c0;'  value=".$row['fldindex'].">".$row['flddatum']."</option>";
//      echo "<option style='background-color:#c0c0c0;' >".$row['fldbez']."</option>";
    }
    echo "</select></td>";
    echo "</tr>";
  }
  if ($auswahltyp=="fldKonto") {
    $sql="SELECT * FROM tblktokonten ";
    $results = $db->query($sql);
    echo "<tr>";
    echo "<td><label >Von Konto:</label></td>";
    echo "<td><select name='vonkonto' size='1'>";
    echo "<option style='background-color:#c0c0c0;' >(ohne)</option>";
    while ($row = $results->fetchArray()) {
      echo "<option style='background-color:#c0c0c0;' >".$row['fldKurz']."</option>";
    }
    echo "</select></td>";
    echo "</tr>";

    $results = $db->query($sql);
    echo "<tr>";
    echo "<td><label >Nach Konto:</label></td>";
    echo "<td><select name='nchkonto' size='1'>";
    echo "<option style='background-color:#c0c0c0;' >(ohne)</option>";
    while ($row = $results->fetchArray()) {
      echo "<option style='background-color:#c0c0c0;' >".$row['fldKurz']."</option>";
    }
    echo "</select></td>";
    echo "</tr>";

  }
  if ($auswahltyp=="SYNC") {
  	//echo $dbtable."=dbtable<br>";
    echo "<tr>";
    echo "<td><label >flddatum:</label></td>";
    echo "<td><input type='text' name='flddatum' value='fldDatum'/></dd>";
    echo "</tr>";
  	
  }
  echo "</table>";

  echo "<dd><input type='submit' value='Speichern' /></dd>";
  echo "</form>";
}

function statusfunc($vondatum,$bisdatum,$vonstatus,$nchstatus,$auswahltyp,$rechdat,$vonort,$nchort,$vonkonto,$nchkonto,$dbtable,$timezonediff,$flddatum) {
  $db = new SQLite3('../data/joorgsqlite.db');
  //echo $auswahltyp."=auswahltyp<br>";
  if ($auswahltyp=="Status") {
    $sql="UPDATE tblfahrtenbuch SET fldStatus='".$nchstatus."' WHERE fldStatus='".$vonstatus."' AND fldVondatum>='".$vondatum."' AND fldVondatum<='".$bisdatum."'";
  } else {
    if ($auswahltyp=="Einkaufsort") {
      $sql="UPDATE tblEinkauf_liste SET fldOrt='".$nchort."' WHERE fldOrt='".$vonort."'";
    } else {
      if ($auswahltyp=="fldKonto") {
        $sql="UPDATE tblEinkauf_liste SET fldKonto='".$nchkonto."' WHERE fldKonto='".$vonkonto."' AND fldEinkaufDatum>='".$vondatum."' AND fldEinkaufDatum<='".$bisdatum."'";
      } else  {	
        if ($auswahltyp=="NOSYNC") {
        	 $sql="UPDATE ".$dbtable." SET flddbsyncstatus='NOSYNC'";
        } else {	
          if ($auswahltyp=="SYNC") {
            if ($timezonediff<>"") {
              $sql="UPDATE ".$dbtable." SET flddbsyncstatus='SYNC', fldtimestamp=datetime('now', 'localtime','".$timezonediff."') WHERE ".$flddatum.">='".$vondatum."' AND ".$flddatum."<='".$bisdatum."'";
            } else {
              $sql="UPDATE ".$dbtable." SET flddbsyncstatus='SYNC', fldtimestamp=datetime('now', 'localtime') WHERE ".$flddatum.">='".$vondatum."' AND ".$flddatum."<='".$bisdatum."'";
            }
          } else {	
            $sql="UPDATE tblfahrtenbuch SET fldind_datum=".$rechdat." WHERE fldVondatum>='".$vondatum."' AND fldVondatum<='".$bisdatum."'";
          }  
        }
      }
    }  
  }
  $reserr = $db->exec($sql);
  echo "<div class='alert alert-success'>";
  echo $auswahltyp."<br>";
  echo $sql."<br>";
  echo "</div>";
}
?>